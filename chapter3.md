# \(三\)基于JWE的加密方案设计

在互联网时代，数据安全的重要性是众所周知的。网络传输环节的安全性是重中之重，开发者们也各自设计了各种形形色色的安全方案，简单罗列下：

* HTTP+对称加密
* HTTP+非对称加密
* HTTP+对称加密+非对称加密
* HTTP+对称加密+信息摘要
* HTTP+非对称加密+信息摘要
* HTTP+对称加密+非对称加密+信息摘要
* HTTPS+明文
* HTTPS+明文+信息摘要
* HTTPS+对称加密+信息摘要
* HTTPS+非对称加密+信息摘要
* HTTPS+对称加密+非对称加密+信息摘要

这么多的安全方案，实际应用过程中应该怎样选择，怎样使用？

## 1. 数据加密方案的演变

### 1.1 HTTP+对称加密

在很久很久以前，互联网发展不久，部分企业开始注重安全，基于对称加密算法，设计了此方案。

如下图所示，用HTTP+AES举例的整个交互流程：

![](/assets/AES.png)整个过程中只涉及到AES\(对称\)算法，仅且对传输中的数据进行加密。

#### 安全性

| 安全项 | 描述 |
| :--- | :--- |
| 数据安全 | 通过AES实现 |
| 数据完整性\(防篡改\) | 无 |
| 数据真实性\(防伪造\) | 无，密钥暴露之后，可以被任意伪造 |

#### 缺陷

> 1. 密钥单一，无法实现动态密钥管理
> 2. 密钥暴露之后，整套方案的安全性不攻自破

### 1.2 HTTP+对称加密+消息摘要

HTTP+对称加密这种方式有个明显的问题，信息在传输过程中可以被任意修改，无法保证数据的完整性，所以产生了此类方案。

如下图所示，用HTTP+AES+HASH摘要举例的整个交互流程：

![](/assets/AES+HASH.png)在AES的加密基础上，做了消息摘要，服务端每次进行解密之前进行摘要验证，保证了数据的完整性。

#### 安全性

| 安全项 | 描述 |
| :--- | :--- |
| 数据安全 | 通过AES实现 |
| 数据完整性\(防篡改\) | 通过信息摘要实现 |
| 数据真实性\(防伪造\) | 通过认证码实现 |

#### 缺陷

> 1. 密钥单一，无法实现动态密钥管理
> 2. 密钥暴露之后，整套方案的安全性不攻自破

### 1.3 HTTP+对称加密+消息认证

HTTP+对称加密+消息摘要的方式已经在一些对安全性要求不是特别高的场合下使用了，但是对于安全性要求特别高的行业比如金融、教育等行业，还有待提高。所以人们改进了摘要机制，把消息摘要用消息认证码替换，形成了HTTP+对称加密+消息认证的方案。

如下图所示，用HTTP+AES+HMAC举例的整个交互流程：

![](/assets/AES+HMAC.png)此方式的特点是用消息认证码替换摘要，在普通的摘要基础上增加双向的校验，保证了数据的真实性。

#### 安全性

| 安全项 | 描述 |
| :--- | :--- |
| 数据安全 | 密钥一旦暴露，客户端和服务端的过程都被破译 |
| 数据完整性\(防篡改\) | 通过认证码实现 |
| 数据真实性\(防伪造\) | 无，密钥暴露之后，可以被任意伪造 |

#### 缺陷

> 1. 密钥单一，无法实现动态密钥管理
> 2. 密钥暴露之后，整套方案的安全性不攻自破

### 1.4 HTTP+非对称加密

前面的方案都是基于非对称加密算法，统一的缺陷就是密钥单一，无法实现动态管理，密钥本身的安全性得到了很大的威胁。基于这个考虑，提出了此方案。

如下图所示，用HTTP+RSA举例过程：

![](/assets/RSA.png)用非对称加密算法，整体替换对称加密算法。安全性都得到了保证，唯一的缺陷就是非对称加密算法的效率太慢，不适合大数据的加密。

#### 安全性

| 安全项 | 描述 |
| :--- | :--- |
| 数据安全 | 通过RSA实现 |
| 数据完整性\(防篡改\) | 通过RSA实现 |
| 数据真实性\(防伪造\) | RSA的公钥和私钥配对实现 |

#### 缺陷

> 1. 性能低下，速度慢
> 2. 不适用于大数据以及文件的加解密

### 1.5 HTTP+对称加密+消息认证+非对称加密

上述所有的方案都有缺陷，缺陷本身来源于加密算法，那么有没有一种办法把对称加密和非对称加密结合起来，互补对方的缺陷呢？

答案是肯定，人类的智慧是无穷，于是想到这种方案：

报文用对称加密，对称算法的密钥用非对称加密，如下图所示，用HTTP+AES+认证+RSA举例：

![](/assets/AES+HMAC+RSA.png)

从安全的层面，该方案已经足够安全，能够达到绝大数的安全需求。现在市面上用此类方案的公司也很多。

#### 特点

> 1，AES加密原始报文，速度快
>
> 2，HMAC对AES结果认证码，确保数据真实性
>
> 3，每次AES和HMAC的密钥都是随机生成，达到动态密钥的效果
>
> 4，密钥的安全由RSA算法保证，数据小，发挥RSA的有点
>
> 5，RSA的密钥为2组，实现了双向认证

## 2.JWE的产生

#### 假设1

假设我们用json格式来描述 HTTP+对称加密+消息认证+非对称加密的方案 的数据，那么json应该这样：

```
{
    "ciphertext": "...",
    "key": "...",
    "authCode": "...",
}
```

客户端和服务端按照约定的算法进行相关操作，就可以正确的加解密数据。

#### 假设2

在假设1的情况下，在json里面增加算法的描述，那么json应该这样：

```
{
    "ciphertext": "...",
    "key": "...",
    "authCode": "...",
    "cipherAlgorithm": "AES128",
    "keyAlgorithm": "RSA1_5",
    "authAlgorithm": "HMAC-SHA256"
}
```

客户端和服务端通信过程中实现指定的算法，就可以正确的加解密数据。

BINGO！到这里，我们来看看我们的主角：JWE

#### 2.1 什么是JWE

JWE的权威说明：[http://self-issued.info/docs/draft-ietf-jose-json-web-encryption.html](http://self-issued.info/docs/draft-ietf-jose-json-web-encryption.html)

JWE是JSON Web Encryption的缩写，意思就是：用json来描述的加密数据结构。

为什么说是数据结构，简单看下一个JWE的例子：

```
{
    "protected": "eyJlbmMiOiJBMTI4Q0JDLUhTMjU2In0",
    "unprotected": {
        "jku": "https://server.example.com/keys.jwks"
    },
    "header": {
        "alg": "A128KW",
        "kid": "7"
    },
    "encrypted_key": "6KB707dM9YTIgHtLvtgWQ8mKwboJW3of9locizkDTHzBC2IlrT1oOQ",
    "iv": "AxY8DCtDaGlsbGljb3RoZQ",
    "ciphertext": "KDlTtXchhZTGufMYmOYGS4HffxPSUrfmqCHXaI9wOGY",
    "tag": "Mz-VPPyU4RlcuYv1IwIvzw"
}
```

跟假设2的数据字段对比，有极其相似的字段，抛开字段的细节，我们看出JWE的结果就是这样的一个数据结构。

